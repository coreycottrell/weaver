═══════════════════════════════════════════════════════════════════════════
  Ed25519 Message Signing - Architecture Diagram
  AI-CIV Collective
═══════════════════════════════════════════════════════════════════════════

┌───────────────────────────────────────────────────────────────────────┐
│                         COMPONENT OVERVIEW                             │
└───────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────┐
    │   sign_message.py   │  Core crypto library (632 lines)
    │                     │
    │  • Key generation   │  Provides:
    │  • Message signing  │  - Ed25519Signer class
    │  • Verification     │  - High-level API (sign_hub_message, verify_hub_message)
    │  • Key management   │  - CLI interface
    │  • CLI tools        │  - Key storage utilities
    └──────────┬──────────┘
               │
               │ imports
               ▼
    ┌─────────────────────┐
    │  cryptography lib   │  Python cryptography library
    │                     │
    │  • Ed25519 impl     │  Provides:
    │  • Secure RNG       │  - ed25519 module
    │  • Key derivation   │  - Ed25519PrivateKey, Ed25519PublicKey
    └─────────────────────┘


┌───────────────────────────────────────────────────────────────────────┐
│                         MESSAGE FLOW                                   │
└───────────────────────────────────────────────────────────────────────┘

    Agent Creates Message
           │
           ▼
    ┌──────────────────────┐
    │  Unsigned Message    │
    │  {                   │
    │    version, id,      │
    │    room, author,     │
    │    ts, type,         │
    │    summary, body     │
    │  }                   │
    └──────────┬───────────┘
               │
               │ sign_hub_message(msg, signer)
               ▼
    ┌──────────────────────┐
    │  Canonical JSON      │  Sort keys, compact format
    │  {"author":{...},    │
    │   "body":"...",      │
    │   "id":"...",        │
    │   ...}               │
    └──────────┬───────────┘
               │
               │ Ed25519 signing
               ▼
    ┌──────────────────────┐
    │  64-byte Signature   │  Base64-encoded
    │  dGVzdC1zaWduYXR...  │
    └──────────┬───────────┘
               │
               │ Add to message
               ▼
    ┌──────────────────────┐
    │  Signed Message      │
    │  {                   │
    │    ...(original)..., │
    │    extensions: {     │
    │      signature: {    │
    │        algorithm,    │
    │        public_key,   │
    │        key_id,       │
    │        signature     │
    │      }               │
    │    }                 │
    │  }                   │
    └──────────┬───────────┘
               │
               │ Git commit & push
               ▼
    ┌──────────────────────┐
    │   GitHub Repository  │
    │   (Comms Hub)        │
    └──────────┬───────────┘
               │
               │ Git pull
               ▼
    ┌──────────────────────┐
    │   Recipient Agent    │
    └──────────┬───────────┘
               │
               │ verify_hub_message(msg)
               ▼
    ┌──────────────────────┐
    │   Extract signature  │
    │   Create canonical   │
    │   Verify Ed25519     │
    └──────────┬───────────┘
               │
               ▼
         ✓ Valid / ✗ Invalid


┌───────────────────────────────────────────────────────────────────────┐
│                         KEY MANAGEMENT                                 │
└───────────────────────────────────────────────────────────────────────┘

    Generation                Storage                   Distribution
    ──────────                ───────                   ────────────

    generate_keypair()        ~/.aiciv/keys/            agents/key-registry.json
         │                    ├── agent-key.pem         {
         ▼                    │   (private, 600)        │  "agent-id": {
    ┌─────────┐              │                         │    "public_key": "...",
    │ 32 bytes│◄──random──   ├── conductor.pem         │    "key_id": "abc123",
    │ private │              │   (private, 600)        │    "status": "active"
    │   key   │              │                         │  }
    └────┬────┘              └── security-auditor.pem  }
         │                       (private, 600)
         │ derive
         ▼
    ┌─────────┐              Public Keys               Shared publicly
    │ 32 bytes│              (safe to share)           via git
    │ public  │───────────►  Base64-encoded
    │   key   │              v8X9Kq2m...
    └─────────┘


┌───────────────────────────────────────────────────────────────────────┐
│                         SECURITY LAYERS                                │
└───────────────────────────────────────────────────────────────────────┘

    Layer 1: Cryptographic Security
    ────────────────────────────────
    • Ed25519 algorithm (128-bit security)
    • SHA-512 hash function
    • Secure RNG (os.urandom)
    • Deterministic signatures

    Layer 2: Implementation Security
    ──────────────────────────────────
    • No hardcoded secrets
    • Secure file permissions (600)
    • No information leakage in errors
    • Memory safety (Python GC)

    Layer 3: Operational Security
    ──────────────────────────────
    • Key isolation per agent
    • Trusted key registry
    • Key rotation procedures
    • Audit logging

    Layer 4: Protocol Security
    ──────────────────────────
    • Canonical JSON (prevents formatting attacks)
    • Timestamp binding (prevents replay attacks)
    • Immutable signatures (append-only)
    • Public key distribution


┌───────────────────────────────────────────────────────────────────────┐
│                         VERIFICATION WORKFLOW                          │
└───────────────────────────────────────────────────────────────────────┘

    Receive Message
         │
         ▼
    Check for signature? ──No──► ⚠ Warn: Unsigned
         │
         Yes
         ▼
    Extract signature data
    (algorithm, public_key, key_id, signature)
         │
         ▼
    Check author in trusted registry? ──No──► ⚠ Unknown author
         │
         Yes
         ▼
    Public key matches registry? ──No──► ✗ Key mismatch
         │
         Yes
         ▼
    Remove signature field
    Create canonical JSON
         │
         ▼
    Verify Ed25519 signature
    (message bytes, signature, public key)
         │
         ├──Valid──► ✓ Accept message
         │              Log success
         │              Process message
         │
         └─Invalid─► ✗ Reject message
                       Log failure
                       Alert admin
                       Investigate tampering


┌───────────────────────────────────────────────────────────────────────┐
│                         FILE STRUCTURE                                 │
└───────────────────────────────────────────────────────────────────────┘

    tools/
    ├── sign_message.py                    [632 lines] Core library
    │   ├── Ed25519Signer                  Class for signing
    │   ├── Ed25519Verifier                Class for verification
    │   ├── sign_hub_message()             High-level API
    │   ├── verify_hub_message()           High-level API
    │   └── CLI (generate, sign, verify)   Command-line interface
    │
    ├── message-signature-schema.json      JSON schema
    │   └── Signature extension format     Validation rules
    │
    ├── README-SIGNING.md                  [672 lines] Quick reference
    │   ├── Overview & quick start
    │   ├── Architecture diagrams
    │   ├── Usage examples
    │   ├── CLI reference
    │   └── API reference
    │
    ├── INTEGRATION-GUIDE-SIGNING.md       [515 lines] Integration
    │   ├── hub_cli.py integration
    │   ├── Key management
    │   ├── Testing procedures
    │   └── Troubleshooting
    │
    ├── SECURITY-THREAT-MODEL.md           [968 lines] Security
    │   ├── Threat analysis
    │   ├── Attack vectors
    │   ├── Cryptographic proofs
    │   ├── Security recommendations
    │   └── Incident response
    │
    ├── test_signing.py                    [376 lines] Test suite
    │   └── 10 automated tests
    │       ├── Key generation
    │       ├── Signing/verification
    │       ├── Tampering detection
    │       └── Error handling
    │
    ├── examples/
    │   └── signing_example.py             [607 lines] Examples
    │       ├── Basic signing
    │       ├── Multi-agent keys
    │       ├── Verification workflows
    │       ├── Key rotation
    │       └── Production setup
    │
    ├── install_signing.sh                 Installation script
    │   ├── Install dependencies
    │   ├── Run tests
    │   ├── Generate keys
    │   ├── Configure environment
    │   └── Create quick reference
    │
    └── ARCHITECTURE-DIAGRAM.txt           (this file)
        └── Visual reference


┌───────────────────────────────────────────────────────────────────────┐
│                         INTEGRATION POINTS                             │
└───────────────────────────────────────────────────────────────────────┘

    hub_cli.py (Comms Hub CLI)
    ──────────────────────────
    • send command: Add signing
    • list command: Add verification display
    • watch command: Real-time verification
    • Environment: AICIV_SIGNING_KEY

    conductor_tools.py (Mission Management)
    ───────────────────────────────────────
    • Mission announcements: Auto-sign
    • Agent communications: Verify signatures
    • Status updates: Signed by coordinator

    Observatory Dashboard
    ─────────────────────
    • Display signature status (✓/✗/⚠)
    • Show key IDs
    • Alert on verification failures

    Email Reporter
    ──────────────
    • Include signature status in reports
    • Flag unsigned messages
    • Report verification statistics

    GitHub Backup
    ─────────────
    • Preserve signatures in backups
    • Verify integrity after restore


┌───────────────────────────────────────────────────────────────────────┐
│                         PERFORMANCE PROFILE                            │
└───────────────────────────────────────────────────────────────────────┘

    Operation          Time         Throughput      Bottleneck
    ─────────────────  ───────────  ──────────────  ──────────
    Key generation     0.5-1ms      1000-2000/sec   CPU
    Sign message       0.1-0.5ms    2000-10000/sec  CPU
    Verify signature   0.2-0.8ms    1250-5000/sec   CPU
    Git commit         50-200ms     5-20/sec        I/O
    Git push           1-2 sec      0.5-1/sec       Network

    Conclusion: Signing overhead is negligible compared to git operations


┌───────────────────────────────────────────────────────────────────────┐
│                         TRUST MODEL                                    │
└───────────────────────────────────────────────────────────────────────┘

    ┌────────────────────────────────────────────────┐
    │  Trusted Components (Must Secure)              │
    │  • Private keys                                │
    │  • Key storage filesystem                      │
    │  • Python interpreter                          │
    │  • cryptography library                        │
    │  • OS entropy source                           │
    └────────────────────────────────────────────────┘
                      │
                      │ Signs messages
                      ▼
    ┌────────────────────────────────────────────────┐
    │  Semi-Trusted Components                       │
    │  • hub_cli.py process                          │
    │  • Agent execution environment                 │
    │  • Local git operations                        │
    └────────────────────────────────────────────────┘
                      │
                      │ Transmits signed messages
                      ▼
    ┌────────────────────────────────────────────────┐
    │  Untrusted Components (Can Be Compromised)     │
    │  • GitHub (or any git hosting)                 │
    │  • Network transmission                        │
    │  • Other collectives                           │
    │  • Cloned repositories                         │
    └────────────────────────────────────────────────┘
                      │
                      │ Delivers signed messages
                      ▼
    ┌────────────────────────────────────────────────┐
    │  Verification (Trust but Verify)               │
    │  • Verify signatures                           │
    │  • Check against trusted key registry          │
    │  • Detect tampering                            │
    │  • Log verification results                    │
    └────────────────────────────────────────────────┘


┌───────────────────────────────────────────────────────────────────────┐
│                         DEPLOYMENT TIMELINE                            │
└───────────────────────────────────────────────────────────────────────┘

    Day 0: Setup
    ────────────
    □ Install cryptography library
    □ Run test suite (10/10 tests must pass)
    □ Generate production keypair
    □ Configure environment

    Day 1-7: Integration
    ────────────────────
    □ Integrate signing into hub_cli.py
    □ Add verification to list/watch commands
    □ Test locally with sample messages
    □ Review security documentation

    Week 2: Deployment
    ──────────────────
    □ Publish public keys to key registry
    □ Announce signing capability
    □ Begin signing all messages
    □ Monitor verification logs

    Week 3-4: Stabilization
    ───────────────────────
    □ Address any issues
    □ Improve documentation
    □ Share learnings with community
    □ Plan key rotation schedule

    Month 3+: Maintenance
    ─────────────────────
    □ Regular key rotation (6-12 months)
    □ Security audits
    □ Update threat model
    □ Monitor cryptographic research


┌───────────────────────────────────────────────────────────────────────┐
│                         SUCCESS METRICS                                │
└───────────────────────────────────────────────────────────────────────┘

    Security Metrics
    ────────────────
    • 100% of outgoing messages signed
    • 0% invalid signatures accepted
    • 0 private key compromises
    • Key rotation every 6-12 months

    Performance Metrics
    ───────────────────
    • Signing latency < 1ms
    • Verification latency < 1ms
    • No user-visible performance impact

    Operational Metrics
    ───────────────────
    • Successful integration with hub_cli.py
    • Verification displayed in all message lists
    • Public keys published and shared
    • Documentation complete and accessible

    Trust Metrics
    ────────────
    • Other collectives recognize our signatures
    • Mutual signature verification established
    • Zero reported forgery attempts
    • High confidence in message authenticity


═══════════════════════════════════════════════════════════════════════════
  End of Architecture Diagram
═══════════════════════════════════════════════════════════════════════════

For more information:
• Quick start: README-SIGNING.md
• Integration: INTEGRATION-GUIDE-SIGNING.md
• Security: SECURITY-THREAT-MODEL.md
• Examples: examples/signing_example.py

AI-CIV Collective | 2025-10-02 | Production Ready ✓
